generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                String                 @id @default(cuid())
  username          String?                @unique
  password          String                 @default("password")
  role              String                 @default("STUDENT")
  frozen            Boolean                @default(false)
  playerRole        String                 @default("UNSET")
  onboarded         Boolean                @default(false)
  managedAssetId    String?
  hedgeFundBalance  Float                  @default(0.0)
  deltaBalance      Float                  @default(100000.0)
  marginLimit       Float                  @default(0.0)
  marginLoan        Float                  @default(0.0)
  lendingLimit      Float                  @default(0.0)
  lendingRate       Float                  @default(0.0)
  backstory         String?
  municipalityId    String?
  politicalRank     Int                    @default(0) // 0=Candidate, 1=Council, 2=Rep, 3=Senator, 4=President
  isNPC             Boolean                @default(false)
  traits            String?                // AI-generated personality traits
  philosophy        String?                // AI-driven political philosophy
  ballotVotes       BallotVote[]
  donationsReceived CampaignDonation[]     @relation("DonationsReceived")
  donationsGiven    CampaignDonation[]     @relation("DonationsGiven")
  candidacies       Candidate[]
  ceoScenarios      CeoScenario[]
  consumerPurchases ConsumerPurchase[]
  bids              GoalAuction[]
  limitOrders       LimitOrder[]
  loansTaken        Loan[]                 @relation("Borrower")
  loansGiven        Loan[]                 @relation("Lender")
  municipalBids     MunicipalContractBid[]
  mayorOf           Municipality?          @relation("MayorOf")
  proposedPolicies  PolicyProposal[]       @relation("ProposedPolicies")
  policyVotes       PolicyVote[]
  portfolios        Portfolio[]
  facilityOwned     ProductionFacility?    @relation("FacilityOwner")
  transactions      Transaction[]
  municipality      Municipality?          @relation("Residents", fields: [municipalityId], references: [id])
  userGoals         UserGoal[]
  unionLeaderOf     WorkforcePool?         @relation("UnionLeaderOf")
}

model Asset {
  id                 String              @id @default(cuid())
  symbol             String              @unique
  name               String
  type               String
  sector             String
  niche              String
  description        String
  supplyPool         Float
  demandPool         Float
  basePrice          Float
  ceoScenarios       CeoScenario[]
  producedGoods      Good[]              @relation("ProducedGoods")
  goodInventories    GoodInventory[]
  inputRequirements  InputRequirement[]  @relation("InputRequirements")
  limitOrders        LimitOrder[]
  portfolios         Portfolio[]
  priceHistory       PriceHistory[]
  productionFacility ProductionFacility?
  sellerContracts    SupplyContract[]    @relation("SellerContracts")
  buyerContracts     SupplyContract[]    @relation("BuyerContracts")
  transactions       Transaction[]
}

model CeoScenario {
  id            String    @id @default(cuid())
  userId        String
  assetId       String
  question      String
  choiceA       String
  choiceB       String
  choiceC       String
  chosenOption  String?
  answeredAt    DateTime?
  newsPublished Boolean   @default(false)
  createdAt     DateTime  @default(now())
  asset         Asset     @relation(fields: [assetId], references: [id])
  user          User      @relation(fields: [userId], references: [id])
}

model Portfolio {
  id                String  @id @default(cuid())
  userId            String
  assetId           String
  quantity          Float
  averageEntryPrice Float
  isShortPosition   Boolean @default(false)
  stopLossPrice     Float?
  takeProfitPrice   Float?
  asset             Asset   @relation(fields: [assetId], references: [id])
  user              User    @relation(fields: [userId], references: [id])

  @@unique([userId, assetId, isShortPosition])
}

model Transaction {
  id          String   @id @default(cuid())
  userId      String
  assetId     String?
  type        String
  amount      Float
  price       Float
  fee         Float
  ticker      String?
  description String?
  timestamp   DateTime @default(now())
  asset       Asset?   @relation(fields: [assetId], references: [id])
  user        User     @relation(fields: [userId], references: [id])
}

model NewsStory {
  id                  String    @id @default(cuid())
  headline            String
  context             String
  targetSector        String
  targetSpecialty     String
  impactScope         String
  direction           String
  intensityWeight     Int
  competitorInversion Boolean
  publishedAt         DateTime? @default(now())
}

model PriceHistory {
  id        String   @id @default(cuid())
  assetId   String
  open      Float
  high      Float
  low       Float
  close     Float
  timestamp DateTime @default(now())
  asset     Asset    @relation(fields: [assetId], references: [id])

  @@index([assetId, timestamp])
}

model GoalCard {
  id             String        @id @default(cuid())
  title          String
  description    String
  criteriaType   String
  criteriaTarget String
  criteriaAmount Float
  victoryPoints  Int
  auctions       GoalAuction[]
  userGoals      UserGoal[]
}

model GoalAuction {
  id              String   @id @default(cuid())
  goalCardId      String
  startTime       DateTime @default(now())
  endTime         DateTime
  minBid          Float
  highestBid      Float    @default(0.0)
  highestBidderId String?
  isActive        Boolean  @default(true)
  highestBidder   User?    @relation(fields: [highestBidderId], references: [id])
  goalCard        GoalCard @relation(fields: [goalCardId], references: [id])
}

model UserGoal {
  id         String   @id @default(cuid())
  userId     String
  goalCardId String
  acquiredAt DateTime @default(now())
  costPaid   Float
  goalCard   GoalCard @relation(fields: [goalCardId], references: [id])
  user       User     @relation(fields: [userId], references: [id])
}

model Loan {
  id           String   @id @default(cuid())
  lenderId     String
  borrowerId   String
  principal    Float
  interestRate Float
  amountOwed   Float
  status       String   @default("ACTIVE")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  borrower     User     @relation("Borrower", fields: [borrowerId], references: [id])
  lender       User     @relation("Lender", fields: [lenderId], references: [id])
}

model LimitOrder {
  id        String   @id @default(cuid())
  userId    String
  assetId   String
  type      String
  quantity  Float
  price     Float
  leverage  Float    @default(1.0)
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  asset     Asset    @relation(fields: [assetId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model InviteCode {
  code         String    @id
  used         Boolean   @default(false)
  usedById     String?
  createdAt    DateTime  @default(now())
  usedAt       DateTime?
  label        String?
  allowedRoles String    @default("CEO,TRADER,HFM")
}

model SectorIndex {
  id         String   @id @default(cuid())
  sector     String
  indexPrice Float
  timestamp  DateTime @default(now())

  @@index([sector, timestamp])
}

model GlobalSetting {
  id    String @id @default(cuid())
  key   String @unique
  value String
}

model Good {
  id                 String              @id @default(cuid())
  name               String
  unit               String
  producerId         String
  currentStockLevel  Float               @default(0.0)
  baseProductionCost Float
  listPrice          Float
  isListedForSale    Boolean             @default(false)
  createdAt          DateTime            @default(now())
  consumerPurchases  ConsumerPurchase[]
  producer           Asset               @relation("ProducedGoods", fields: [producerId], references: [id])
  inventories        GoodInventory[]
  inputRequirements  InputRequirement[]  @relation("InputGood")
  municipalContracts MunicipalContract[]
  contracts          SupplyContract[]
}

model InputRequirement {
  id            String @id @default(cuid())
  consumerId    String
  inputGoodId   String
  unitsPerCycle Float
  inputGood     Good   @relation("InputGood", fields: [inputGoodId], references: [id])
  consumer      Asset  @relation("InputRequirements", fields: [consumerId], references: [id])
}

model SupplyContract {
  id            String   @id @default(cuid())
  buyerId       String
  sellerId      String
  goodId        String
  pricePerUnit  Float
  unitsPerCycle Float
  status        String   @default("ACTIVE")
  autoRenew     Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  good          Good     @relation(fields: [goodId], references: [id])
  seller        Asset    @relation("SellerContracts", fields: [sellerId], references: [id])
  buyer         Asset    @relation("BuyerContracts", fields: [buyerId], references: [id])
}

model GoodInventory {
  id       String @id @default(cuid())
  assetId  String
  goodId   String
  quantity Float  @default(0.0)
  good     Good   @relation(fields: [goodId], references: [id])
  asset    Asset  @relation(fields: [assetId], references: [id])

  @@unique([assetId, goodId])
}

model ConsumerPurchase {
  id          String   @id @default(cuid())
  userId      String
  goodId      String
  quantity    Float
  pricePaid   Float
  purchasedAt DateTime @default(now())
  good        Good     @relation(fields: [goodId], references: [id])
  user        User     @relation(fields: [userId], references: [id])
}

model Municipality {
  id           String              @id @default(cuid())
  name         String              @unique
  mayorId      String?             @unique
  goodsTaxRate Float               @default(0.02)
  deltaReserve Float               @default(0.0)
  createdAt    DateTime            @default(now())
  description  String?
  elections    Election[]
  contracts    MunicipalContract[]
  events       MunicipalEvent[]
  mayor        User?               @relation("MayorOf", fields: [mayorId], references: [id])
  residents    User[]              @relation("Residents")
}

model MunicipalContract {
  id               String                 @id @default(cuid())
  municipalityId   String
  goodId           String
  quantityRequired Float
  budgetDelta      Float
  deadline         DateTime
  status           String                 @default("OPEN")
  awardedBidId     String?                @unique
  createdAt        DateTime               @default(now())
  awardedBid       MunicipalContractBid?  @relation("AwardedBid", fields: [awardedBidId], references: [id])
  good             Good                   @relation(fields: [goodId], references: [id])
  municipality     Municipality           @relation(fields: [municipalityId], references: [id])
  bids             MunicipalContractBid[]
}

model MunicipalContractBid {
  id              String             @id @default(cuid())
  contractId      String
  bidderId        String
  pricePerUnit    Float
  submittedAt     DateTime           @default(now())
  awardedContract MunicipalContract? @relation("AwardedBid")
  bidder          User               @relation(fields: [bidderId], references: [id])
  contract        MunicipalContract  @relation(fields: [contractId], references: [id])
}

model ProductionFacility {
  id              String         @id @default(cuid())
  assetId         String         @unique
  ownerId         String         @unique
  maxCapacity     Int            @default(100)
  currentCapacity Int            @default(100)
  wages           Float          @default(50.0)
  headcount       Int            @default(10)
  onStrike        Boolean        @default(false)
  createdAt       DateTime       @default(now())
  owner           User           @relation("FacilityOwner", fields: [ownerId], references: [id])
  asset           Asset          @relation(fields: [assetId], references: [id])
  workforcePool   WorkforcePool?
}

model WorkforcePool {
  id            String             @id @default(cuid())
  unionLeaderId String             @unique
  facilityId    String             @unique
  memberCount   Int                @default(0)
  wagesDemand   Float              @default(50.0)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  strikes       StrikeAction[]
  facility      ProductionFacility @relation(fields: [facilityId], references: [id])
  unionLeader   User               @relation("UnionLeaderOf", fields: [unionLeaderId], references: [id])
}

model StrikeAction {
  id              String        @id @default(cuid())
  workforcePoolId String
  reason          String
  startedAt       DateTime      @default(now())
  endedAt         DateTime?
  isActive        Boolean       @default(true)
  workforcePool   WorkforcePool @relation(fields: [workforcePoolId], references: [id])
}

model PolicyProposal {
  id           String       @id @default(cuid())
  proposerId   String
  title        String
  description  String
  policyType   String
  targetSector String?
  targetRole   String?
  effectValue  Float
  status       String       @default("VOTING")
  votesFor     Int          @default(0)
  votesAgainst Int          @default(0)
  endsAt       DateTime
  createdAt    DateTime     @default(now())
  proposer     User         @relation("ProposedPolicies", fields: [proposerId], references: [id])
  votes        PolicyVote[]
}

model PolicyVote {
  id         String         @id @default(cuid())
  proposalId String
  voterId    String
  inFavor    Boolean
  votedAt    DateTime       @default(now())
  voter      User           @relation(fields: [voterId], references: [id])
  proposal   PolicyProposal @relation(fields: [proposalId], references: [id])

  @@unique([proposalId, voterId])
}

model CampaignDonation {
  id          String   @id @default(cuid())
  donorId     String
  recipientId String
  amount      Float
  message     String?
  donatedAt   DateTime @default(now())
  recipient   User     @relation("DonationsReceived", fields: [recipientId], references: [id])
  donor       User     @relation("DonationsGiven", fields: [donorId], references: [id])
}

model Election {
  id             String       @id @default(cuid())
  municipalityId String
  electionType   String
  status         String       @default("CAMPAIGNING")
  campaignStart  DateTime     @default(now())
  votingStart    DateTime
  votingEnd      DateTime
  winnerId       String?
  ballotVotes    BallotVote[]
  candidates     Candidate[]
  municipality   Municipality @relation(fields: [municipalityId], references: [id])
}

model Candidate {
  id         String   @id @default(cuid())
  electionId String
  userId     String?
  npcName    String?
  npcBio     String?
  isNpc      Boolean  @default(false)
  voteCount  Int      @default(0)
  user       User?    @relation(fields: [userId], references: [id])
  election   Election @relation(fields: [electionId], references: [id])
}

model BallotVote {
  id          String   @id @default(cuid())
  electionId  String
  voterId     String
  candidateId String
  votedAt     DateTime @default(now())
  voter       User     @relation(fields: [voterId], references: [id])
  election    Election @relation(fields: [electionId], references: [id])

  @@unique([electionId, voterId])
}

model MunicipalEvent {
  id             String       @id @default(cuid())
  municipalityId String
  eventType      String
  title          String
  content        String
  publishedAt    DateTime     @default(now())
  municipality   Municipality @relation(fields: [municipalityId], references: [id])
}
